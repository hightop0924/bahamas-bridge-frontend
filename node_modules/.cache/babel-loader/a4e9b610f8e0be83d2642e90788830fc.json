{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __exportStar = this && this.__exportStar || function (m, exports) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst messageFormatter_1 = require(\"./messageFormatter\");\nclass PostMessageCommunicator {\n  constructor(allowedOrigins = null, debugMode = false) {\n    this.allowedOrigins = null;\n    this.callbacks = new Map();\n    this.debugMode = false;\n    this.isValidMessage = ({\n      origin,\n      data,\n      source\n    }) => {\n      const emptyOrMalformed = !data;\n      const sentFromParentEl = source === window.parent;\n      const majorVersionNumber = typeof data.version !== 'undefined' && parseInt(data.version.split('.')[0]);\n      const allowedSDKVersion = majorVersionNumber >= 1;\n      let validOrigin = true;\n      if (Array.isArray(this.allowedOrigins)) {\n        validOrigin = this.allowedOrigins.find(regExp => regExp.test(origin)) !== undefined;\n      }\n      return !emptyOrMalformed && sentFromParentEl && allowedSDKVersion && validOrigin;\n    };\n    this.logIncomingMessage = msg => {\n      console.info(`Safe Apps SDK v1: A message was received from origin ${msg.origin}. `, msg.data);\n    };\n    this.onParentMessage = msg => {\n      if (this.isValidMessage(msg)) {\n        this.debugMode && this.logIncomingMessage(msg);\n        this.handleIncomingMessage(msg.data);\n      }\n    };\n    this.handleIncomingMessage = payload => {\n      const {\n        id\n      } = payload;\n      const cb = this.callbacks.get(id);\n      if (cb) {\n        cb(payload);\n        this.callbacks.delete(id);\n      }\n    };\n    this.send = (method, params) => {\n      const request = messageFormatter_1.MessageFormatter.makeRequest(method, params);\n      if (typeof window === 'undefined') {\n        throw new Error(\"Window doesn't exist\");\n      }\n      window.parent.postMessage(request, '*');\n      return new Promise((resolve, reject) => {\n        this.callbacks.set(request.id, response => {\n          if (!response.success) {\n            reject(new Error(response.error));\n            return;\n          }\n          resolve(response);\n        });\n      });\n    };\n    this.allowedOrigins = allowedOrigins;\n    this.debugMode = debugMode;\n    window.addEventListener('message', this.onParentMessage);\n  }\n}\nexports.default = PostMessageCommunicator;\n__exportStar(require(\"./methods\"), exports);","map":{"version":3,"sources":["../../../src/communication/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst messageFormatter_1 = require(\"./messageFormatter\");\nclass PostMessageCommunicator {\n    constructor(allowedOrigins = null, debugMode = false) {\n        this.allowedOrigins = null;\n        this.callbacks = new Map();\n        this.debugMode = false;\n        this.isValidMessage = ({ origin, data, source }) => {\n            const emptyOrMalformed = !data;\n            const sentFromParentEl = source === window.parent;\n            const majorVersionNumber = typeof data.version !== 'undefined' && parseInt(data.version.split('.')[0]);\n            const allowedSDKVersion = majorVersionNumber >= 1;\n            let validOrigin = true;\n            if (Array.isArray(this.allowedOrigins)) {\n                validOrigin = this.allowedOrigins.find((regExp) => regExp.test(origin)) !== undefined;\n            }\n            return !emptyOrMalformed && sentFromParentEl && allowedSDKVersion && validOrigin;\n        };\n        this.logIncomingMessage = (msg) => {\n            console.info(`Safe Apps SDK v1: A message was received from origin ${msg.origin}. `, msg.data);\n        };\n        this.onParentMessage = (msg) => {\n            if (this.isValidMessage(msg)) {\n                this.debugMode && this.logIncomingMessage(msg);\n                this.handleIncomingMessage(msg.data);\n            }\n        };\n        this.handleIncomingMessage = (payload) => {\n            const { id } = payload;\n            const cb = this.callbacks.get(id);\n            if (cb) {\n                cb(payload);\n                this.callbacks.delete(id);\n            }\n        };\n        this.send = (method, params) => {\n            const request = messageFormatter_1.MessageFormatter.makeRequest(method, params);\n            if (typeof window === 'undefined') {\n                throw new Error(\"Window doesn't exist\");\n            }\n            window.parent.postMessage(request, '*');\n            return new Promise((resolve, reject) => {\n                this.callbacks.set(request.id, (response) => {\n                    if (!response.success) {\n                        reject(new Error(response.error));\n                        return;\n                    }\n                    resolve(response);\n                });\n            });\n        };\n        this.allowedOrigins = allowedOrigins;\n        this.debugMode = debugMode;\n        window.addEventListener('message', this.onParentMessage);\n    }\n}\nexports.default = PostMessageCommunicator;\n__exportStar(require(\"./methods\"), exports);\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}